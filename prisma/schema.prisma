// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
  relationMode = "prisma"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
  relationMode = "prisma"
}

enum role {
  USER
  ADMIN
  SUPER_USER
}

enum UserStatus {
  ACTIVE        // 사용중
  BANNED        // 영구정지
  DELETED       // 삭제
  SUSPENDED_7D  // 7일정지
  SUSPENDED_30D // 한달정지
}

enum MessageType {
  TEXT
  IMAGE
}

enum GuinnessRecordType {
  size
  weight
}

enum GuinnessSubmissionStatus {
  pending
  approved
  rejected
}

enum GuinnessRejectionReasonCode {
  photo_blur
  measurement_not_visible
  contact_missing
  invalid_value
  insufficient_description
  suspected_manipulation
  other
}

model User {
  id              Int         @id @default(autoincrement())
  role            role        @default(USER)
  status          UserStatus @default(ACTIVE)
  snsId           String      @unique
  provider        String      
  phone           String?     @unique
  email           String?     @unique
  name            String      @unique
  avatar          String?
  createdAt       DateTime    @default(now())
  updatedAt       DateTime    @updatedAt
  products        Product[]
  posts           Post[]
  Likes           Like[]
  Comments        Comment[]
  writtenReviews  Review[]    @relation(name: "writtenReviews")
  receivedReviews Review[]    @relation(name: "receivedReviews")
  fav             Fav[]
  sales           Sale[]
  purchases       Purchase[]
  record          Record[]
  messages        Message[]
  followers       Follow[]    @relation(name: "follower")
  following       Follow[]    @relation(name: "following")
  chatRoomMember    ChatRoomMember[]
  notifications     Notification[]  @relation(name: "notifications")
  sentNotifications Notification[]  @relation(name: "sentNotifications")
  fcmTokens         FcmToken[]
  auctions        Auction[]
  bids            Bid[]
  insectRecords   InsectRecord[]
  guinnessSubmissions GuinnessSubmission[]
}
model ChatRoom {
  id              Int               @id @default(autoincrement())
  createdAt       DateTime          @default(now())
  updatedAt       DateTime          @updatedAt
  messages        Message[]
  chatRoomMembers ChatRoomMember[]
}


model ChatRoomMember {
  id         Int      @id @default(autoincrement())
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  chatRoom   ChatRoom @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  chatRoomId Int
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt @default(now())
  lastReadAt DateTime?

  @@unique([userId, chatRoomId])
  @@index([chatRoomId])
  @@index([userId])
}


model Message {
  id         Int         @id @default(autoincrement())
  type       MessageType @default(TEXT)
  message    String
  image      String?     // Cloudflare Images ID (IMAGE 타입일 때 사용)
  chatRoom   ChatRoom    @relation(fields: [chatRoomId], references: [id], onDelete: Cascade)
  chatRoomId Int
  user       User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  createdAt  DateTime    @default(now())
  updatedAt  DateTime    @updatedAt

  @@index([chatRoomId])
  @@index([userId])
}




model Follow {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  follower    User     @relation(name: "follower", fields: [followerId], references: [id], onDelete: Cascade)
  followerId  Int
  following   User     @relation(name: "following", fields: [followingId], references: [id], onDelete: Cascade)
  followingId Int

  @@index([followerId])
  @@index([followingId])

}

model Product {
  id          Int         @id @default(autoincrement())
  name        String
  price       Int?
  description String
  photos      String[]
  createdAt   DateTime    @default(now())
  updatedAt   DateTime    @updatedAt
  user        User        @relation(fields: [userId], references: [id])
  userId      Int
  favs        Fav[]
  sales       Sale[]
  purchases   Purchase[]
  records     Record[]
  // 2025.04.26일 추가 필드(아직 미사용)
  category String? // 예를 들면 곤충/강아지/고양이/파충류/물고기/기타/전체 등등 
  tags     String[]  // 태그는 문자열 배열로 저장
  isSold    Boolean @default(false)
  isDeleted Boolean @default(false)
  isHidden  Boolean @default(false)
  location       String?    // 거래 지역
  viewCount      Int        @default(0) // 조회수
  wishCount      Int        @default(0) // 찜/관심 수
  status         String     @default("판매중") // 판매 상태: 판매중, 예약중, 판매완료 등
  condition      String?    // 상품 컨디션: 새상품, 중고 등
  contactCount   Int        @default(0) // 문의/채팅 수
  expireAt       DateTime?  // 게시글 만료일
  deliveryType   String?    // 직거래/택배 등
  priceOfferable Boolean    @default(true) // 가격 제안 가능 여부
  mainImage      String?    // 대표 이미지
  isFeatured     Boolean    @default(false) // 추천 상품 여부
  reportCount    Int        @default(0) // 신고 횟수
  productType    String?    // 생물, 용품

  @@index([userId])
  @@index([category])
  @@index([status])
}

model Post {
  id        Int         @id @default(autoincrement())
  createdAt DateTime    @default(now())
  updatedAt DateTime    @updatedAt
  user      User        @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  title    String
  description String
  type String?
  category  String?     // 게시글 카테고리 (자유, 질문, 정보, 자랑, 후기)
  comments Comment[]
  latitude  Float?
  longitude Float?
  Likes      Like[]
  image       String

  @@index([userId])
  @@index([category])
}

model Comment {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    Int
  comment String

  @@index([userId])
  @@index([postId])

}


model Like {
  id        Int      @id @default(autoincrement())
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  postId    Int

  @@index([userId])
  @@index([postId])

}

model Review {
  id           Int      @id @default(autoincrement())
  createdAt    DateTime @default(now())
  updatedAt    DateTime @updatedAt
  review       String   
  createdBy    User     @relation(name: "writtenReviews", fields: [createdById], references: [id], onDelete: Cascade)
  createdById  Int
  createdFor   User     @relation(name: "receivedReviews", fields: [createdForId], references: [id], onDelete: Cascade)
  createdForId Int
  score        Int      @default(1)

  @@index([createdById])
  @@index([createdForId])

}

model Sale {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  status    String   @default("pending") // pending, completed
  @@index([userId])
  @@index([productId])
}

model Purchase {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  status    String   @default("pending") // pending, completed
  @@index([userId])
  @@index([productId])
}

model Fav {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
  @@index([userId])
  @@index([productId])
}

model Record {
  id        Int      @id @default(autoincrement())
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  product   Product  @relation(fields: [productId], references: [id], onDelete: Cascade)
  productId Int
  createdAt DateTime @default(now())
  kind      String
  updatedAt DateTime @updatedAt
  @@index([userId])
  @@index([productId])
}

enum Kind {
  Purchase
  Sale
  Fav
}

enum NotificationType {
  LIKE          // 좋아요
  COMMENT       // 댓글
  CHAT          // 채팅 메시지
  FOLLOW        // 팔로우
  FAV           // 상품 찜
  NEW_PRODUCT   // 팔로우한 유저가 새 상품 등록
  NEW_POST      // 팔로우한 유저가 새 게시글 등록
  BID           // 내 경매에 새 입찰
  OUTBID        // 내가 입찰한 경매에서 더 높은 입찰 발생
  AUCTION_WON   // 경매 낙찰
  AUCTION_END   // 내 경매 종료
  NEW_RECORD    // 기네스북 기록 갱신
}

model Notification {
  id         Int              @id @default(autoincrement())
  type       NotificationType
  message    String           // 알림 메시지 (예: "홍길동님이 좋아요를 눌렀습니다")
  isRead     Boolean          @default(false)
  user       User             @relation(name: "notifications", fields: [userId], references: [id], onDelete: Cascade)
  userId     Int              // 알림을 받는 유저
  sender     User             @relation(name: "sentNotifications", fields: [senderId], references: [id], onDelete: Cascade)
  senderId   Int              // 알림을 발생시킨 유저
  targetId   Int?             // 대상 ID (게시글, 상품, 채팅방, 경매 등)
  targetType String?          // 대상 타입 ("post", "product", "chatRoom", "auction")
  createdAt  DateTime         @default(now())
  updatedAt  DateTime         @updatedAt

  @@index([userId])
  @@index([senderId])
  @@index([userId, isRead])
}

model FcmToken {
  id        Int      @id @default(autoincrement())
  token     String   @unique
  userAgent String?
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId    Int
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([userId])
  @@index([userId, updatedAt])
}

// ============================================================
// 경매 시스템
// ============================================================

model Auction {
  id              Int       @id @default(autoincrement())
  title           String
  description     String
  photos          String[]
  category        String?   // 종 카테고리 (장수풍뎅이, 사슴벌레 등)
  sellerPhone     String?
  sellerEmail     String?
  sellerBlogUrl   String?
  sellerCafeNick  String?
  sellerBandNick  String?
  sellerProofImage String?
  sellerTrustNote String?
  startPrice      Int       // 시작가
  currentPrice    Int       // 현재 최고 입찰가
  minBidIncrement Int       @default(1000) // 최소 입찰 단위 (원)
  endAt           DateTime  // 경매 종료 시간
  status          String    @default("진행중") // 진행중, 종료, 유찰, 취소

  user            User      @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId          Int
  bids            Bid[]
  winnerId        Int?      // 낙찰자 ID

  createdAt       DateTime  @default(now())
  updatedAt       DateTime  @updatedAt

  @@index([userId])
  @@index([status])
  @@index([endAt])
  @@index([category])
}

model Bid {
  id         Int      @id @default(autoincrement())
  amount     Int      // 입찰 금액
  user       User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId     Int
  auction    Auction  @relation(fields: [auctionId], references: [id], onDelete: Cascade)
  auctionId  Int
  createdAt  DateTime @default(now())

  @@index([auctionId])
  @@index([userId])
}

// ============================================================
// 기네스북 (곤충 기록 시스템)
// ============================================================

model InsectRecord {
  id          Int      @id @default(autoincrement())
  species     String   // 종명 (장수풍뎅이, 사슴벌레 등)
  recordType  String   // "size" (크기 mm) 또는 "weight" (무게 g)
  value       Float    // 실제 측정값
  photo       String   // 증거 사진 (Cloudflare Image ID)
  description String?  // 추가 설명

  user        User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  userId      Int

  isVerified  Boolean  @default(false) // 관리자 검증 여부

  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([species, recordType])
  @@index([userId])
  @@index([species, recordType, value])
}

model GuinnessSpecies {
  id         Int      @id @default(autoincrement())
  name       String   @unique
  aliases    String[]
  isActive   Boolean  @default(true)
  isOfficial Boolean  @default(true)
  createdAt  DateTime @default(now())
  updatedAt  DateTime @updatedAt

  submissions GuinnessSubmission[]
}

model GuinnessSubmission {
  id               Int      @id @default(autoincrement())
  userId           Int
  userName         String
  species          String
  speciesId        Int?
  speciesRawText   String?
  recordType       GuinnessRecordType
  value            Float
  measurementDate  DateTime?
  description      String?
  proofPhotos      String[]
  contactPhone     String?
  contactEmail     String?
  consentToContact Boolean
  submittedAt      DateTime @default(now())
  slaDueAt         DateTime
  resubmitCount    Int      @default(0)
  status           GuinnessSubmissionStatus @default(pending)
  reviewReasonCode GuinnessRejectionReasonCode?
  reviewMemo       String?
  reviewedBy       Int?
  reviewedAt       DateTime?
  approvedRecordId Int?
  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  user        User            @relation(fields: [userId], references: [id], onDelete: Cascade)
  speciesRef  GuinnessSpecies? @relation(fields: [speciesId], references: [id], onDelete: SetNull)

  @@index([userId])
  @@index([species, recordType])
  @@index([status])
}

model AdminBanner {
  id          Int      @id @default(autoincrement())
  title       String
  description String
  href        String
  bgClass     String
  order       Int
  image       String?
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([order])
}

model LandingPage {
  id          Int      @id @default(autoincrement())
  slug        String   @unique
  title       String
  content     String
  isPublished Boolean  @default(true)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt

  @@index([isPublished])
}
